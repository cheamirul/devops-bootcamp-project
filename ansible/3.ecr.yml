---
- name: pull image from ECR and run container
  hosts: web
  become: true
  tasks:
    - name: Log in to AWS ECR
      shell: |
        aws ecr get-login-password --region {{ aws_region }} | sudo docker login --username AWS --password-stdin {{ ecr_registry_url }}
      become: false

    - name: Pull image from ECR
      community.docker.docker_image:
        name: "{{ ecr_registry_url }}/{{ ecr_repository }}:latest"
        source: pull
    
    - name: Run Docker container
      community.docker.docker_container:
        name: web_app
        image: "{{ ecr_registry_url }}/{{ ecr_repository }}:latest"
        state: started
        restart_policy: unless-stopped
        ports:
          - "80:80"
        env:
          USER_NAME: "{{ user_name }}"